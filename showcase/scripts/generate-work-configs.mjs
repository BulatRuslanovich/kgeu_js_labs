#!/usr/bin/env node

import fs from "fs/promises";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const showcaseDir = path.resolve(__dirname, "..");
const projectRoot = path.resolve(showcaseDir, "..");
const assignmentsDir = path.join(projectRoot, "assignments");
const generatedFile = path.join(showcaseDir, "workConfigs.generated.js");

try {
  await fs.access(assignmentsDir);
} catch {
  throw new Error(
    `Не найден каталог с заданиями: ${assignmentsDir}. Создайте его или обновите путь в generate-work-configs.mjs.`,
  );
}

const dirEntries = await fs.readdir(assignmentsDir, { withFileTypes: true });

const workIds = dirEntries
  .filter(
    (entry) =>
      entry.isDirectory() && /^(?:lab|prac)_\d+$/i.test(entry.name ?? ""),
  )
  .map((entry) => entry.name ?? "")
  .sort((a, b) => {
    const typeOrder = (name) =>
      name.startsWith("lab_") ? 0 : name.startsWith("prac_") ? 1 : 2;
    const typeDiff = typeOrder(a) - typeOrder(b);
    if (typeDiff !== 0) return typeDiff;

    const numA = Number(a.match(/\d+/)?.[0] ?? 0);
    const numB = Number(b.match(/\d+/)?.[0] ?? 0);
    if (numA !== numB) return numA - numB;

    return a.localeCompare(b);
  });

const buildTitle = (name) => {
  const match = name.match(/^(lab|prac)_(\d+)$/i);
  if (!match) return name;

  const [, kindRaw, numberRaw] = match;
  const number = Number(numberRaw);

  if (kindRaw.toLowerCase() === "lab") {
    return `Лаба ${number}`;
  }

  if (kindRaw.toLowerCase() === "prac") {
    return `Практика ${number}`;
  }

  return name;
};

const works = workIds.map((id) => ({
  id,
  title: buildTitle(id),
  fsPath: path.join(assignmentsDir, id),
  directory: `assignments/${id}`,
}));

const extractInfoLine = (content) => {
  const lines = content.split(/\r?\n/);
  for (const line of lines) {
    const match = line.match(/^\s*\/\/\s*INFO:\s*(.*)$/i);
    if (match) {
      return match[1].trim() || "-";
    }
  }
  return "-";
};

const stringify = (value) => JSON.stringify(value);

const configLines = [];
configLines.push(
  "// This file is auto-generated by showcase/scripts/generate-work-configs.mjs",
);
configLines.push("// Do not edit manually.");
configLines.push("");
configLines.push("const workConfigs = {");

for (const work of works) {
  const workDir = work.fsPath;

  const entries = await fs.readdir(workDir);
  const hasPdf = entries.includes("tasks.pdf");
  const jsFiles = entries
    .filter((name) => /^task\d+\.js$/i.test(name))
    .sort(
      (a, b) =>
        parseInt(a.match(/\d+/)[0], 10) - parseInt(b.match(/\d+/)[0], 10),
    );

  const tasks = [];

  for (const file of jsFiles) {
    const id = file.replace(/\.js$/i, "");
    const filePath = path.join(workDir, file);
    const content = await fs.readFile(filePath, "utf8");
    const title = extractInfoLine(content);

    tasks.push({ id, title, file });
  }

  configLines.push(`  '${work.id}': {`);
  configLines.push(`    id: '${work.id}',`);
  configLines.push(`    title: ${stringify(work.title)},`);
  configLines.push(`    directory: ${stringify(work.directory)},`);

  if (hasPdf) {
    configLines.push("    tasksPdf: true,");
  }

  configLines.push("    tasks: [");

  for (const task of tasks) {
    configLines.push("      {");
    configLines.push(`        id: '${task.id}',`);
    configLines.push(`        title: ${stringify(task.title)},`);
    configLines.push(`        file: '${task.file}',`);
    configLines.push("      },");
  }

  configLines.push("    ],");
  configLines.push("  },");
}

configLines.push("};");
configLines.push("");
configLines.push("export default workConfigs;");
configLines.push("");

await fs.writeFile(generatedFile, configLines.join("\n"), "utf8");

console.log(`Generated ${path.relative(projectRoot, generatedFile)}`);
